<html>
<script src='https://d3js.org/d3.v5.min.js'></script>
<script src='jquery-3.5.1.min.js'></script>
<script src='sum.js'></script>
<script src='https://ajax.googleapis.com/ajax/libs/jqueryui/1.11.2/jquery-ui.min.js'></script>
<!--Source for slider: https://codepen.io/caseymhunt/pen/kertA-->
<style>
    @import url('slider.css');

    #btn {
        margin: 4px;
    }

    .container {
        margin: auto;
        text-align: center;
    }

    .chart {
        width: 1000px;
        padding: 10px;
        height: 500px;
        position: absolute;
        margin-top: -250px;
        margin-left: -450px;
        top: 50%;
        left: 50%;
    }

    .note {
        font-size: 8px;
    }

    .svg {
        display: block;
        width: 1000px;
    }

    h3 {
        font-family: sans-serif;
    }

</style>

<body onload='init()'>

    <div class='container'>
        <h3>Abortions in Illinois from 1995 - 2012</h3>
        <svg class='chart' width=1000 height=500 preserveAspectRatio='xMidYMid meet' /><br />

        <!--        <button class='btn' type='button'>Button</button>-->

        <div id='dualSlider'>
            <p>Age Range: <span class='rangeLower'>0 - </span>
                <span class='rangeUpper'>45+</span><br /><span class='note'></span>

            </p>
            <div class='sliderStep'>
                <div id='slider'></div>
            </div>
        </div>

    </div>
</body>

<script>
    //  Sources: 
    //  https://www.d3-graph-gallery.com/graph/line_basic.html
    //  https://stackoverflow.com/questions/21715201/unable-to-reference-d3-js-data-imported-from-a-csv-file-with-spaces-in-the-heade
    async function init() {
        const data = await d3.csv('Abortion_Demographics.csv');

        const cols = data.columns.slice(8, 17);
        var vals = new Array();

        data.forEach(function(d) {
            for (i = 0; i < cols.length; i++) {
                vals.push([]);
                vals[i].push(+d[cols[i]]);
            }
        });

        const round = 500;
        const dim = 350;
        const width = dim * 2;
        const margin = 75;
        const axisFactor = 0.5;

        var svg = d3.select('svg')
            .append('g')
            .attr('transform', 'translate(' + margin + ',' + 10 + ')');

        var x = d3.scaleTime()
            .domain([new Date(1995, 0, 1), new Date(2012, 0, 1)])
            .range([0, width]);

        var ymin = Math.floor(d3.min(data, function(d) {
            return +d.inState;
        }) / round) * round;

        var ymax = Math.ceil(d3.max(data, function(d) {
            return +d.inState;
        }) / round) * round;

        var y = d3.scaleLinear()
            .domain([ymin, ymax])
            .range([dim, 0]);

        var lineChart = svg.append('path')
            .datum(data)
            .attr('fill', 'none')
            .attr('stroke', 'purple')
            .attr('stroke-width', 2)
            .attr('d', d3.line()
                .x(function(d) {
                    return x(new Date(+d.year, 0, 1))
                })
                .y(function(d) {
                    return y(+d.inState)
                })
            );

        var xaxis = svg.append('g')
            .attr('transform', 'translate(' + 0 + ',' + dim + ')')
            .call(d3.axisBottom(x).ticks(d3.timeYear));

        svg.append('text')
            .attr('transform', 'translate(' + (width / 2) + ',' + (dim + margin * axisFactor) + ')')
            .style('text-anchor', 'middle')
            .text('Year');

        var yaxis = svg.append('g')
            .attr('transform', 'translate(' + 0 + ',' + 0 + ')')
            .call(d3.axisLeft(y).ticks(10));

        svg.append('text')
            .attr('transform', 'translate(' + (-10 - margin * axisFactor) + ',' + (dim / 2) + ')rotate(' + -90 + ')')
            .style('text-anchor', 'middle')
            .text('Abortions');



        function update(values) {
            newVals = vals[values[0]];

            for (i = values[0] + 1; i <= values[1]; i++) {
                newVals = sumArr(newVals, vals[i]);
            }

            var newData = data.map(function(d, i) {
                return {
                    x: +d.year,
                    y: +newVals[i]
                };
            });

            ymin = Math.floor(d3.min(newData, function(d) {
                return +d.y;
            }) / round) * round;

            ymax = Math.ceil(d3.max(newData, function(d) {
                return +d.y;
            }) / round) * round;

            y = d3.scaleLinear()
                .domain([ymin, ymax])
                .range([dim, 0]);
            yaxis.transition().duration(1700).call(d3.axisLeft(y).ticks(10));

            lineChart.datum(newData)
                .transition()
                .duration(1700)
                .attr('d', d3.line()
                    .x(function(d) {
                        return x(new Date(+d.x, 0, 1));
                    })
                    .y(function(d) {
                        return y(+d.y);
                    })
                )
        }

        var ageLower = [0, 15, 18, 20, 25, 30, 35, 40, 45];
        var ageUpper = [14, 17, 19, 24, 29, 34, 39, 44, 45];

        $('#slider').slider({
            range: true,
            min: 0,
            max: 8,
            step: 1,
            values: [0, 8],
            slide: function(e, ui) {
                if (ui.values[0] !== 8)
                    $('.rangeLower').html(ageLower[ui.values[0]] + ' - ');
                else $('.rangeLower').html('');

                if (ui.values[1] !== 8)
                    $('.rangeUpper').html(ageUpper[ui.values[1]]);
                else
                    $('.rangeUpper').html(ageUpper[ui.values[1]] + '+');

                if (ui.values[0] == 8 && ui.values[1] == 8)
                    $('.note').html('\nâ€ data values below or equal to 50 are recorded as 50.');
                else
                    $('.note').html('');

                update(ui.values)
            }
        });

        var values = $('#slider').slider('option', 'values');

        //        $('.btn').click(function() {
        //            $(this).html(values[0]);
        //        });
    }

</script>


</html>
